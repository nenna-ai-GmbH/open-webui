---
description: Svelte/TS guide for PII integration, session manager, and debug overlay
globs: src/**/*.ts,src/**/*.svelte
---

### PII Integration Cheatsheet

- Session manager singleton: `PiiSessionManager.getInstance()` from [pii.ts](mdc:src/lib/utils/pii.ts)
- Conversation entities for UI/API:
  - Display/active set (persistent + working + temporary for new chats): `getEntitiesForDisplay(chatId)`
  - Known entities for API payload: `getKnownEntitiesForApi(chatId)`
- Persisted state acquisition when loading chats: `loadConversationState(chatId, piiState)`
- Save hook used by session manager: window `triggerPiiChatSave(chatId)` is implemented in [Chat.svelte](mdc:src/lib/components/chat/Chat.svelte)
- Commit working entities when sending: `commitConversationWorkingEntities(chatId)`
- Modifiers for API: `getModifiersForApi(chatId)`

### Debug Overlay Toggle (Admin Only)

- Slash command in [Chat.svelte](mdc:src/lib/components/chat/Chat.svelte): `/pii-debug on|off|toggle`
- Overlay only renders for admins and when `showPiiDebug` is true
- Persisted in `sessionStorage` as `piiDebug`

### TipTap/ProseMirror Extension

- Editor detection: [PiiDetectionExtension.ts](mdc:src/lib/components/common/RichTextInput/PiiDetectionExtension.ts)
- Debounce default: 500ms (configurable)

